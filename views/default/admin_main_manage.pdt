<?php /** @var View $this */ ?>

<?php
    echo $message ?? null;

    $link_buttons = [
        [
            'icon' => 'bi bi-arrow-left me-1',
            'name' => $this->_('AdminMain.manage.back', true),
            'attributes' => [
                'title' => $this->_('AdminMain.manage.back', true),
                'href' => $this->Html->safe($this->base_uri . 'plugin/cms/admin_main/')
            ]
        ]
    ];

    $this->Widget->clear();
    $this->Widget->setLinkButtons($link_buttons);
    $this->Widget->setBodyWrapper(false);
    $this->Widget->create($this->_('AdminMain.manage.boxtitle', true));

    $this->Form->create(null, ['id' => 'portal_form']);
?>
    <div class="card-body">
        <div class="mb-3">
            <?php $this->Form->label($this->_('AdminMain.manage.label.uri', true), 'uri', ['class' => 'form-label']); ?>
            <?php $this->Form->fieldText('uri', $uri ?? null, ['id' => 'uri', 'class' => 'form-control']); ?>
        </div>

        <ul class="nav nav-tabs-connected" role="tablist">
            <?php foreach ($languages as $i => $lang) { ?>
                <li class="nav-item" role="presentation">
                    <button class="nav-link<?= ($lang->code ?? null) == Configure::get('Blesta.language') ? ' active' : '' ?>" data-bs-toggle="tab" data-bs-target="#tab-<?= $this->Html->safe($lang->code) ?>" type="button" role="tab">
                        <?= $this->Html->safe($lang->name ?? null) ?>
                    </button>
                </li>
            <?php } ?>
        </ul>
        <div class="tab-content tab-content-connected mb-3">
            <?php foreach ($languages as $i => $lang) { ?>
                <?php $page = (object)($vars[$lang->code] ?? $pages[$lang->code] ?? []); ?>
                <div class="tab-pane fade<?= ($lang->code ?? null) == Configure::get('Blesta.language') ? ' show active' : '' ?>" id="tab-<?= $this->Html->safe($lang->code) ?>" role="tabpanel">
                    <div class="mb-3">
                        <?php $this->Form->label($this->_('AdminMain.manage.label.title', true), 'title-' . $lang->code, ['class' => 'form-label']); ?>
                        <?php $this->Form->fieldText('pages[' . $lang->code . '][title]', ($page->title ?? null), ['id' => 'title-' . $lang->code, 'class' => 'form-control']); ?>
                    </div>
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading mb-2"><i class="bi bi-tags me-2"></i><?php $this->_('AdminMain.manage.label.tags'); ?></h6>
                        <div class="d-flex flex-wrap gap-2">
                            <?php foreach (($tags ?? []) as $tag) { ?>
                                <code><?= $this->Html->safe($tag ?? null) ?></code>
                            <?php } ?>
                        </div>
                    </div>
                    <div class="mb-3">
                        <?php $this->Form->label($this->_('AdminMain.manage.label.content_type', true), 'content_type', ['class' => 'form-label d-block']) ?>
                        <?php foreach ($content_types as $type => $name) { ?>
                            <div class="form-check form-check-inline">
                                <?php $this->Form->fieldRadio('pages[' . $lang->code . '][content_type]', $type, ($page->content_type ?? array_keys($content_types ?? [])[0] ?? null) == $type, ['id' => 'content_type_' . $type . '-' . $i, 'class' => 'form-check-input content_type']) ?>
                                <?php $this->Form->label($name, 'content_type_' . $type . '-' . $i, ['class' => 'form-check-label']) ?>
                            </div>
                        <?php } ?>
                    </div>
                    <?php foreach ($content_types as $type => $name) {?>
                        <?php $current_type = $type == ($page->content_type ?? array_keys($content_types ?? [])[0] ?? null); ?>
                        <div class="mb-3 content <?= 'content_' . $type ?>"<?= $current_type ? '' : ' style="display:none"' ?>>
                            <?php
                                $attributes = $current_type ? ['class' => 'form-control'] : ['disabled' => '', 'class' => 'form-control'];
                                switch($type) {
                                    case 'wysiwyg':
                                        $attributes['class'] = 'wysiwyg';
                                        break;
                                    case 'md':
                                        $attributes['data-markdown-editor'] = '';
                                        unset($attributes['disabled']);
                                        break;
                                }

                                $this->Form->label($this->_('AdminMain.manage.label.content', true), 'content-' . $type . '-' . $lang->code, ['class' => 'form-label']);
                                $this->Form->fieldTextarea('pages[' . $lang->code . '][content]', ($page->content_type ?? array_keys($content_types ?? [])[0] ?? null) == $type ? ($page->content ?? null) : '', array_merge($attributes, ['id' => 'content-' . $type . '-' . $lang->code, 'rows' => 12]));
                            ?>
                        </div>
                    <?php } ?>
                </div>
            <?php } ?>
        </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
        <?php $this->Form->fieldSubmit('save', $this->_('AdminMain.manage.submit', true), ['class' => 'btn btn-primary']); ?>
    </div>
<?php
    $this->Form->end();
    $this->Widget->end();
?>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // CKEditor initialization for wysiwyg textareas
    function initCKEditorOnTextarea(textarea) {
        if (!textarea || textarea.ckeditorInstance) {
            return;
        }

        if (typeof ClassicEditor === 'undefined') {
            setTimeout(function() { initCKEditorOnTextarea(textarea); }, 500);
            return;
        }

        var config = {
            toolbar: {
                items: [
                    'heading',
                    'fontFamily',
                    'fontSize',
                    'highlight',
                    '|',
                    'fontColor',
                    'fontBackgroundColor',
                    'bold',
                    'italic',
                    'link',
                    'removeFormat',
                    '|',
                    'bulletedList',
                    'numberedList',
                    'alignment',
                    'indent',
                    'outdent',
                    '|',
                    'imageUpload',
                    'blockQuote',
                    'insertTable',
                    'mediaEmbed',
                    'codeBlock',
                    'htmlEmbed',
                    'horizontalLine',
                    '|',
                    'sourceEditing',
                    'undo',
                    'redo'
                ]
            },
            image: {
                toolbar: [
                    'imageTextAlternative',
                    'imageStyle:inline',
                    'imageStyle:block',
                    'imageStyle:side'
                ]
            },
            language: '<?php echo substr(Configure::get('Blesta.language'), 0, 2);?>'
        };

        ClassicEditor.create(textarea, config)
            .then(function(editor) {
                textarea.ckeditorInstance = editor;
            })
            .catch(function(error) {
                console.error('CKEditor initialization error:', error);
            });
    }

    // Initialize CKEditor on all visible wysiwyg textareas
    function initAllWysiwygEditors() {
        document.querySelectorAll('textarea.wysiwyg').forEach(function(textarea) {
            if (!textarea.ckeditorInstance && textarea.offsetParent !== null) {
                initCKEditorOnTextarea(textarea);
            }
        });
    }

    // Initialize on page load
    initAllWysiwygEditors();

    // Re-initialize when tab is shown
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(function(tabEl) {
        tabEl.addEventListener('shown.bs.tab', function(event) {
            var targetId = event.target.getAttribute('data-bs-target');
            if (targetId) {
                var targetPane = document.querySelector(targetId);
                if (targetPane) {
                    var textareas = targetPane.querySelectorAll('textarea.wysiwyg');
                    textareas.forEach(function(textarea) {
                        if (!textarea.ckeditorInstance) {
                            initCKEditorOnTextarea(textarea);
                        }
                    });
                }
            }
        });
    });

    // Content type switching
    document.querySelectorAll('.content_type').forEach(function(radio) {
        radio.addEventListener('change', function() {
            var container = this.closest('.tab-pane');

            container.querySelectorAll('.content').forEach(function(el) {
                el.style.display = 'none';
                var textarea = el.querySelector('textarea');
                if (textarea) {
                    textarea.setAttribute('disabled', '');
                }
            });

            var selected = container.querySelector('.content_' + this.value);
            if (selected) {
                selected.style.display = 'block';
                var textarea = selected.querySelector('textarea');
                if (textarea) {
                    textarea.removeAttribute('disabled');
                    // Initialize WYSIWYG editor if switching to wysiwyg type
                    if (textarea.classList.contains('wysiwyg') && !textarea.ckeditorInstance) {
                        initCKEditorOnTextarea(textarea);
                    }
                }
            }
        });
    });

    document.querySelectorAll('.content[style*="display: none"], .content[style*="display:none"]').forEach(function(el) {
        var textarea = el.querySelector('textarea');
        if (textarea) {
            textarea.setAttribute('disabled', '');
        }
    });
});
</script>
